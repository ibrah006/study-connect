<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StudyConnect - University Student Networking Platform</title>
  </head>
  <body>

    <!-- QardHasana widget snippet -->
    <!-- <script src="https://qardhasana.com/_api/widget?hostIdentifier=test-host&assetId=2"></script> -->

    <script>
     (function () {
  "use strict";

  // --- START: CSS for the widget ---
  const css = `
    /* Trigger Button Styles */
    #qardhasana-trigger-button {
      all: initial;
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 999999;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #qardhasana-trigger-button button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 28px;
      background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(21, 128, 61, 0.3), 0 0 0 0 rgba(21, 128, 61, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      animation: pulse-shadow 2s infinite;
    }

    @keyframes pulse-shadow {
      0%, 100% {
        box-shadow: 0 8px 32px rgba(21, 128, 61, 0.3), 0 0 0 0 rgba(21, 128, 61, 0.4);
      }
      50% {
        box-shadow: 0 8px 32px rgba(21, 128, 61, 0.4), 0 0 0 8px rgba(21, 128, 61, 0);
      }
    }

    #qardhasana-trigger-button button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 40px rgba(21, 128, 61, 0.4);
      background: linear-gradient(135deg, #166534 0%, #15803d 100%);
    }

    #qardhasana-trigger-button button:active {
      transform: translateY(-1px) scale(1);
    }

    #qardhasana-trigger-button svg {
      animation: heartbeat 1.5s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      10%, 30% { transform: scale(1.15); }
      20%, 40% { transform: scale(1); }
    }

    /* Modal Overlay */
    #qardhasana-modal-overlay {
      all: initial;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 20px;
    }

    #qardhasana-modal-overlay.show {
      opacity: 1;
    }

    /* Modal Container */
    #qardhasana-widget-container {
      all: initial;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
      background: linear-gradient(145deg, #ffffff 0%, #f0fdf4 100%);
      border-radius: 24px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
      position: relative;
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      padding: 40px;
      box-sizing: border-box;
    }

    #qardhasana-widget-container * {
      box-sizing: border-box;
    }

    #qardhasana-modal-overlay.show #qardhasana-widget-container {
      transform: scale(1) translateY(0);
    }

    /* Close Button */
    .close-button {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }

    .close-button:hover {
      background: rgba(0, 0, 0, 0.1);
      transform: rotate(90deg);
    }

    .close-button svg {
      width: 20px;
      height: 20px;
      stroke: #6b7280;
    }

    /* Header */
    .widget-header {
      margin-bottom: 32px;
    }

    .widget-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0 0 8px;
      color: #0f172a;
      line-height: 1.2;
    }

    .widget-subtitle {
      font-size: 16px;
      color: #64748b;
      margin: 0;
      line-height: 1.5;
    }

    /* Progress Section */
    .progress-section {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(21, 128, 61, 0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 16px;
    }

    .stat {
      flex: 1;
      text-align: left;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #15803d;
    }

    .stat-value.secondary {
      color: #0f172a;
    }

    /* Progress Bar */
    .progress-bar-container {
      width: 100%;
      height: 12px;
      background: rgba(21, 128, 61, 0.1);
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #15803d 0%, #16a34a 100%);
      border-radius: 20px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Action Tabs */
    .action-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: rgba(0, 0, 0, 0.03);
      padding: 6px;
      border-radius: 12px;
    }

    .tab-button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #64748b;
      font-family: inherit;
    }

    .tab-button.active {
      background: white;
      color: #15803d;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Form */
    .donation-form {
      text-align: left;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #0f172a;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      background: white;
      color: #0f172a;
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: #15803d;
      box-shadow: 0 0 0 3px rgba(21, 128, 61, 0.1);
    }

    .form-input::placeholder {
      color: #94a3b8;
    }

    .amount-suggestions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .amount-chip {
      padding: 8px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
    }

    .amount-chip:hover {
      border-color: #15803d;
      color: #15803d;
      transform: translateY(-2px);
    }

    /* Info Box */
    .info-box {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      border: 1px solid #a7f3d0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .info-box svg {
      flex-shrink: 0;
      margin-top: 2px;
    }

    .info-box-text {
      font-size: 13px;
      color: #065f46;
      line-height: 1.5;
      margin: 0;
      text-align: left;
    }

    /* Checkbox */
    .checkbox-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 24px;
    }

    .checkbox-input {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      cursor: pointer;
      flex-shrink: 0;
      accent-color: #15803d;
    }

    .checkbox-label {
      font-size: 13px;
      color: #475569;
      line-height: 1.5;
      cursor: pointer;
      text-align: left;
    }

    /* Submit Button */
    .submit-button {
      width: 100%;
      background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
      color: white;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(21, 128, 61, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(21, 128, 61, 0.4);
    }

    .submit-button:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Back Button */
    .back-button {
      width: 100%;
      background: transparent;
      color: #64748b;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }

    .back-button:hover {
      border-color: #15803d;
      color: #15803d;
    }

    /* Payment Screen */
    .payment-screen {
      display: none;
    }

    .payment-screen.active {
      display: block;
    }

    #payment-element {
      margin-bottom: 20px;
    }

    .payment-error {
      color: #dc2626;
      font-size: 14px;
      margin-top: 12px;
      text-align: center;
    }

    /* Success/Error Screens */
    .result-screen {
      display: none;
      text-align: center;
    }

    .result-screen.active {
      display: block;
    }

    .result-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-icon.success {
      background: #dcfce7;
    }

    .result-icon.error {
      background: #fee2e2;
    }

    .result-icon svg {
      width: 48px;
      height: 48px;
    }

    .result-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 12px;
      color: #0f172a;
    }

    .result-message {
      font-size: 16px;
      color: #64748b;
      margin: 0 0 24px;
      line-height: 1.5;
    }

    /* Powered By */
    .powered-by {
      margin-top: 24px;
      font-size: 12px;
      color: #94a3b8;
      text-align: center;
    }

    .powered-by a {
      color: #15803d;
      text-decoration: none;
      font-weight: 600;
    }

    .powered-by a:hover {
      text-decoration: underline;
    }

    /* Screen visibility */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* Mobile Responsiveness */
    @media (max-width: 640px) {
      #qardhasana-widget-container {
        padding: 24px;
      }

      .widget-title {
        font-size: 24px;
      }

      .stat-value {
        font-size: 20px;
      }

      .progress-stats {
        flex-direction: column;
        gap: 12px;
      }
    }
  `;

  const styleSheet = document.createElement("style");
  styleSheet.innerText = css;
  document.head.appendChild(styleSheet);

  // Load Stripe.js
  const stripeScript = document.createElement("script");
  stripeScript.src = "https://js.stripe.com/v3/";
  stripeScript.async = true;
  document.head.appendChild(stripeScript);

  // --- Widget rendering ---
  function renderWidget() {
    // Trigger button
    const triggerContainer = document.createElement("div");
    triggerContainer.id = "qardhasana-trigger-button";
    triggerContainer.innerHTML = `
      <button type='button'>
        <svg width='20' height='20' viewBox='0 0 24 24' fill='currentColor'>
          <path d='M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z'/>
        </svg>
        Support
      </button>`;

    document.body.appendChild(triggerContainer);

    // Modal overlay
    const modalOverlay = document.createElement("div");
    modalOverlay.id = "qardhasana-modal-overlay";
    modalOverlay.style.display = "none";

    modalOverlay.innerHTML = `
      <div id='qardhasana-widget-container'>
        <button type='button' class='close-button' id='close-modal'>
          <svg viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
            <path d='M18 6L6 18M6 6l12 12'/>
          </svg>
        </button>

        <!-- Screen 1: Donation/Loan Selection -->
        <div class='screen active' id='selection-screen'>
          <div class='widget-header'>
            <h1 class='widget-title'>365 Subscription</h1>
            <p class='widget-subtitle'>Support this cause through QardHasana</p>
          </div>

          <div class='progress-section'>
            <div class='progress-stats'>
              <div class='stat'>
                <div class='stat-label'>Raised</div>
                <div class='stat-value'>$0</div>
              </div>
              <div class='stat'>
                <div class='stat-label'>Goal</div>
                <div class='stat-value secondary'>$150</div>
              </div>
            </div>
            <div class='progress-bar-container'>
              <div class='progress-bar-fill' style='width: 0%'></div>
            </div>
          </div>

          <div class='action-tabs'>
            <button type='button' class='tab-button active' data-tab='donate'>
              <span>‚ù§Ô∏è Support</span>
            </button>
            <button type='button' class='tab-button' data-tab='loan'>
              <span>ü§ù Lend</span>
            </button>
          </div>

          <form class='donation-form' id='donation-form'>
            <div id='donate-content'>
              <div class='info-box'>
                <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='#15803d' stroke-width='2'>
                  <circle cx='12' cy='12' r='10'/>
                  <path d='M12 16v-4M12 8h.01'/>
                </svg>
                <p class='info-box-text'>
                  Support this initiative with a voluntary contribution. Please note that contributions are non-refundable.
                </p>
              </div>

              <div class='form-group'>
                <label class='form-label' for='amount'>Donation Amount</label>
                <input type='number' id='amount' class='form-input' placeholder='Enter amount ($5 - $150)' min='5' max='150' step='5' required />
                <div class='amount-suggestions'>
                  <div class='amount-chip' data-amount='25'>$25</div>
                  <div class='amount-chip' data-amount='50'>$50</div>
                  <div class='amount-chip' data-amount='100'>$100</div>
                  <div class='amount-chip' data-amount='250'>$250</div>
                </div>
              </div>
            </div>

            <div id='loan-content' style='display: none;'>
              <div class='info-box'>
                <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='#15803d' stroke-width='2'>
                  <circle cx='12' cy='12' r='10'/>
                  <path d='M12 16v-4M12 8h.01'/>
                </svg>
                <p class='info-box-text'>
                  Provide an interest-free loan (Qard Hasan) that will be repaid. Maximum loan amount: $150
                </p>
              </div>

              <div class='form-group'>
                <label class='form-label' for='loan-amount'>Loan Amount</label>
                <input type='number' id='loan-amount' class='form-input' placeholder='Enter amount ($5 - $150)' min='5' max='150' step='5' />
                <div class='amount-suggestions'>
                  <div class='amount-chip' data-amount='50'>$50</div>
                  <div class='amount-chip' data-amount='100'>$100</div>
                  <div class='amount-chip' data-amount='250'>$250</div>
                  <div class='amount-chip' data-amount='500'>$500</div>
                </div>
              </div>

              <div class='form-group'>
                <label class='form-label' for='repayment-months'>Repayment Period</label>
                <select id='repayment-months' class='form-input' required>
                  <option value=''>Select repayment period</option>
                  <option value='3'>3 months</option>
                  <option value='4'>4 months</option>
                  <option value='5'>5 months</option>
                  <option value='6'>6 months</option>
                </select>
              </div>
            </div>

            <div class='form-group'>
              <label class='form-label' for='name'>Name (Optional)</label>
              <input type='text' id='name' class='form-input' placeholder='Your name' />
            </div>

            <div class='checkbox-container'>
              <input type='checkbox' id='intent-checkbox' class='checkbox-input' required />
              <label for='intent-checkbox' class='checkbox-label'>
                I am contributing purely out of admiration and willingness to help, not for profit.
              </label>
            </div>

            <button type='submit' class='submit-button'>
              <span id='submit-text'>Proceed to Payment</span>
              <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
                <path d='M5 12h14M12 5l7 7-7 7'/>
              </svg>
            </button>
          </form>
        </div>

        <!-- Screen 2: Payment -->
        <div class='screen' id='payment-screen'>
          <div class='widget-header'>
            <h1 class='widget-title'>Complete Payment</h1>
            <p class='widget-subtitle' id='payment-amount-text'></p>
          </div>

          <div id='payment-element'></div>
          
          <div id='payment-error' class='payment-error' style='display: none;'></div>

          <button type='button' class='submit-button' id='submit-payment' disabled>
            <span>Processing...</span>
          </button>

          <button type='button' class='back-button' id='back-to-selection'>
            <svg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
              <path d='M19 12H5M12 19l-7-7 7-7'/>
            </svg>
            <span>Back</span>
          </button>
        </div>

        <!-- Screen 3: Success -->
        <div class='screen' id='success-screen'>
          <div class='result-icon success'>
            <svg viewBox='0 0 24 24' fill='none' stroke='#16a34a' stroke-width='2'>
              <path d='M20 6L9 17l-5-5'/>
            </svg>
          </div>
          <h2 class='result-title'>Thank You!</h2>
          <p class='result-message' id='success-message'></p>
          <button type='button' class='submit-button' id='close-success'>
            <span>Close</span>
          </button>
        </div>

        <!-- Screen 4: Error -->
        <div class='screen' id='error-screen'>
          <div class='result-icon error'>
            <svg viewBox='0 0 24 24' fill='none' stroke='#dc2626' stroke-width='2'>
              <path d='M18 6L6 18M6 6l12 12'/>
            </svg>
          </div>
          <h2 class='result-title'>Payment Failed</h2>
          <p class='result-message' id='error-message'></p>
          <button type='button' class='submit-button' id='try-again'>
            <span>Try Again</span>
          </button>
          <button type='button' class='back-button' id='close-error'>
            <span>Close</span>
          </button>
        </div>

        <div class='powered-by'>
          Powered by <a href='https://qardhasana.com' target='_blank'>QardHasana</a>
        </div>
      </div>`;

    document.body.appendChild(modalOverlay);

    // Widget logic
    
    let currentTab = 'donate';
    let stripe = null;
    let elements = null;
    let paymentIntentId = null;
    let contributionData = null;

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function openModal() {
      modalOverlay.style.display = "flex";
      setTimeout(() => modalOverlay.classList.add("show"), 10);
      document.body.style.overflow = 'hidden';

      // initial tab
      switchTab("donate");
    }

    function closeModal() {
      modalOverlay.classList.remove("show");
      setTimeout(() => {
        modalOverlay.style.display = "none";
        document.body.style.overflow = '';
        showScreen('selection-screen');
        document.getElementById('donation-form').reset();
      }, 300);
    }

    function switchTab(tab) {
      currentTab = tab;
      console.log("current tab:", tab);
      const donateContent = document.getElementById('donate-content');
      const loanContent = document.getElementById('loan-content');
      const submitText = document.getElementById('submit-text');
      const tabs = document.querySelectorAll('.tab-button');

      tabs.forEach(t => {
        if (t.dataset.tab === tab) {
          t.classList.add('active');
        } else {
          t.classList.remove('active');
        }
      });

      const donateInputs = document.querySelectorAll('#donate-content input');
      const loanInputs = document.querySelectorAll('#loan-content input, #loan-content select');

      if (tab === 'donate') {
        donateContent.style.display = 'block';
        loanContent.style.display = 'none';
        submitText.textContent = 'Proceed to Payment';

        donateInputs.forEach(i => i.required = true);
        loanInputs.forEach(i => i.required = false);
      } else {
        donateContent.style.display = 'none';
        loanContent.style.display = 'block';
        submitText.textContent = 'Proceed to Payment';

        donateInputs.forEach(i => i.required = false);
        loanInputs.forEach(i => i.required = true);
      }
    }

    async function initializeStripe() {
      let attempts = 0;
      while (!window.Stripe && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }

      if (!window.Stripe) {
        throw new Error('Failed to load Stripe.js');
      }

      stripe = window.Stripe('pk_test_51S8I31GVL6MmKL0eJCnPCZfTeur3Ac2cQeSzniGUYD9O1ZxR6L0ia87KsB497Mf2LXD34OfTqHlerkexU2cLPfHn00rZHuGOB6');
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value;
      const intent = document.getElementById('intent-checkbox').checked;
      
      if (!intent) {
        alert('Please confirm your contribution intent');
        return;
      }

      let amount, type, repaymentMonths;
      if (currentTab === 'donate') {
        amount = document.getElementById('amount').value;
        type = 'donation';
      } else {
        amount = document.getElementById('loan-amount').value;
        const repaymentSelect = document.getElementById('repayment-months');
        // FIX 1: Check if element exists before accessing value
        if (repaymentSelect) {
          repaymentMonths = parseInt(repaymentSelect.value);
        }
        type = 'loan';
        
        // FIX 2: Only check repaymentMonths for loans if the element exists
        if (repaymentSelect && !repaymentMonths) {
          alert('Please select a repayment period');
          return;
        }
      }

      if (!amount || amount < 5) {
        alert('Please enter a valid amount (minimum $5)');
        return;
      }

      contributionData = {
        assetId: 2,
        amount: parseFloat(amount),
        name: name || 'Anonymous',
        type: type,
        repaymentMonths: repaymentMonths || undefined,
      };

      showScreen('payment-screen');
      
      // FIX 3: Escape the dollar signs in template literal
      const amountText = type === 'donation' ? 'Donation' : 'Loan';
      document.getElementById('payment-amount-text').textContent = 
        amountText + ': $' + parseFloat(amount).toFixed(2);

      try {
        if (!stripe) {
          await initializeStripe();
          console.log("stripe initialized");
        }

        const apiUrl = 'https://qardhasana.com/_api/payments/widget-intent';

        console.log("attempting to POST widget intent");
        // FIX 4: Use superjson format correctly
        let response;
        try {

          response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
            },
            body: JSON.stringify({
              assetId: contributionData.assetId,
              amount: parseFloat(contributionData.amount),
              type: contributionData.type,
              donorName: contributionData.name,
              repaymentMonths: contributionData.repaymentMonths,
            }),
          });

        } catch(e) {
          console.log("actual error response:", e);
          showScreen('error-screen');
          return;
        }

        // Debug, SUCCESS: NO CORS ISSUE
        showScreen('success-screen');
        return;
        

        const text = await response.text();
        console.log('Response text:', text);
        
        if (!response.ok) {
          let errorMessage = 'Failed to create payment intent';
          try {
            const errorData = JSON.parse(text);
            errorMessage = errorData.error || errorMessage;

            console.log("error caught here try:", errorData);
          } catch (e) {
            errorMessage = text || errorMessage;
            console.log("error caught here:", e);
          }
          throw new Error(errorMessage);
        } else {
          console.log("POST widget intent success, response text:", JSON.parse(text));
        }

        // FIX 5: Parse response properly (could be superjson or regular JSON)
        let data;
        try {
          const parsed = JSON.parse(text);
          // Handle both superjson format and regular JSON
          data = parsed.json || parsed;
        } catch (e) {
          console.log("error:", e);
          throw new Error('Invalid response format from server');
        }

        if (!data || !data.clientSecret) {
          throw new Error('Invalid response format from server');
        }

        const clientSecret = data.clientSecret;
        elements = stripe.elements({
          clientSecret: clientSecret,
        });

        const paymentElement = elements.create('payment', {
          layout: 'tabs',
        });
        paymentElement.mount('#payment-element');

        paymentElement.on('ready', () => {
          const submitBtn = document.getElementById('submit-payment');
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span>Complete Payment</span>';
        });

        paymentElement.on('change', (event) => {
          const errorDiv = document.getElementById('payment-error');
          if (event.error) {
            errorDiv.textContent = event.error.message;
            errorDiv.style.display = 'block';
          } else {
            errorDiv.style.display = 'none';
          }
        });
      } catch (error) {
        console.error('Payment initialization error:', error);
        document.getElementById('error-message').textContent = 
          error.message || 'Failed to initialize payment. Please try again.';
        showScreen('error-screen');
      }
    }

    async function handlePayment() {
      const submitBtn = document.getElementById('submit-payment');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span>Processing...</span>';

      const errorDiv = document.getElementById('payment-error');
      errorDiv.style.display = 'none';

      try {
        const result = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: 'https://qardhasana.com',
          },
          redirect: 'if_required',
        });

        if (result.error) {
          throw result.error;
        }

        paymentIntentId = result.paymentIntent.id;

        // Record the contribution in the backend
        const endpoint = contributionData.type === 'donation' 
          ? '/_api/asset/donate' 
          : '/_api/asset/loan';
        
        const payload = contributionData.type === 'donation'
          ? {
              paymentIntentId: paymentIntentId,
              assetId: contributionData.assetId,
              amount: contributionData.amount,
              donorName: contributionData.name,
              disclaimerAccepted: true,
            }
          : {
              paymentIntentId: paymentIntentId,
              assetId: contributionData.assetId,
              principalAmount: contributionData.amount,
              repaymentMonths: contributionData.repaymentMonths,
              lenderName: contributionData.name,
              lenderDisclaimerAccepted: true,
            };

        const recordResponse = await fetch('https://qardhasana.com' + endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        const recordText = await recordResponse.text();
        console.log('Record response text:', recordText);
        console.log('Record response status code:', recordResponse.status);
        
        if (!recordResponse.ok) {
          let errorMessage = 'Failed to record contribution';
          try {
            const errorData = JSON.parse(recordText);
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            errorMessage = recordText || errorMessage;
          }
          throw new Error(errorMessage);
        }

        const successMessage = 'Your ' + contributionData.type + ' of $' + 
          contributionData.amount.toFixed(2) + ' has been processed successfully. Thank you for your support!';
        document.getElementById('success-message').textContent = successMessage;
        showScreen('success-screen');
      } catch (error) {
        console.error('Payment error:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Complete Payment</span>';
        errorDiv.textContent = error.message || 'Payment failed. Please try again.';
        errorDiv.style.display = 'block';
      }
    }

    // Event listeners
    triggerContainer.querySelector("button").addEventListener("click", openModal);
    document.getElementById('close-modal').addEventListener("click", closeModal);
    
    modalOverlay.addEventListener("click", function(e) {
      if (e.target === modalOverlay) {
        closeModal();
      }
    });

    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    document.querySelectorAll('.amount-chip').forEach(chip => {
      chip.addEventListener('click', function() {
        const amount = this.dataset.amount;
        if (currentTab === 'donate') {
          document.getElementById('amount').value = amount;
        } else {
          document.getElementById('loan-amount').value = amount;
        }
      });
    });

    document.getElementById('donation-form').addEventListener('submit', handleSubmit);
    document.getElementById('back-to-selection').addEventListener('click', () => showScreen('selection-screen'));
    document.getElementById('submit-payment').addEventListener('click', handlePayment);
    document.getElementById('close-success').addEventListener('click', closeModal);
    document.getElementById('try-again').addEventListener('click', () => showScreen('selection-screen'));
    document.getElementById('close-error').addEventListener('click', closeModal);

  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", renderWidget);
  } else {
    renderWidget();
  }
})();
    </script>
    
    
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
